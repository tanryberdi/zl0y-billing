# Микросервис Billing для zl0y.team

MVP бэкенда для личного кабинета сервиса анализа цифровых отпечатков zl0y.team. 
Данный микросервис обрабатывает аутентификацию пользователей, управление отчетами и функции биллинга.

## Обзор архитектуры

Сервис реализует паттерн чистой архитектуры со следующими слоями:

- **Handlers**: HTTP обработчики запросов (фреймворк Gin)
- **Services**: Слой бизнес-логики
- **Repositories**: Слой доступа к данным
- **Models**: Структуры данных и DTO

## Проектирование баз данных

### PostgreSQL (Пользователи)
- **Таблица**: `users`
- **Назначение**: Хранение информации о пользователях и биллинге
- **Индексы**:
    - Первичный ключ на `id`
    - Уникальный индекс на `login` для быстрой аутентификации

### MongoDB (Отчеты)
- **Коллекция**: `reports`
- **Назначение**: Хранение метаданных отчетов и статуса покупки
- **Индексы**:
    - Уникальный индекс на `report_id` для быстрого поиска отчетов
    - Индекс на `user_id` для запросов отчетов пользователя
    - Индекс на `client_generated_id` для привязки анонимных отчетов
    - Составной индекс на `(user_id, created_at)` для эффективной пагинации

Выбор PostgreSQL для пользователей обеспечивает ACID-совместимость для финансовых данных (баланс), 
а MongoDB предоставляет гибкость для метаданных отчетов и хорошо масштабируется для операций чтения.

## Структура проекта

```
zl0y-billing/
├── main.go                 # Точка входа приложения
├── go.mod                  # Описание Go модуля
├── go.sum                  # Контрольные суммы Go модулей
├── Dockerfile              # Конфигурация сборки Docker
├── docker-compose.yml      # Оркестрация сервисов
├── .env                    # Переменные окружения
├── README.md               # Этот файл
└── internal/
    ├── config/             # Управление конфигурацией
    │   └── config.go
    ├── database/           # Подключения к базам данных
    │   ├── postgres.go
    │   └── mongo.go
    ├── handlers/           # HTTP обработчики
    │   ├── auth.go
    │   ├── user.go
    │   ├── report.go
    │   └── mock.go
    ├── middleware/         # HTTP middleware
    │   └── auth.go
    ├── models/             # Модели данных
    │   └── models.go
    ├── repository/         # Слой доступа к данным
    │   ├── user.go
    │   └── report.go
    └── service/            # Бизнес-логика
        ├── auth.go
        ├── user.go
        └── report.go
```

## Функциональность

- **Аутентификация пользователей**: JWT-аутентификация с хешированием паролей через bcrypt
- **Управление отчетами**: Привязка анонимных отчетов к зарегистрированным пользователям
- **Система биллинга**: Покупка отчетов с проверкой баланса
- **Mock API**: Имитация внешнего сервиса для тестирования
- **Пагинация**: Эффективное отображение списка отчетов с limit/offset
- **Имитация транзакций**: Обработка согласованности между базами данных

## Быстрый старт

### Предварительные требования
- Docker и Docker Compose
- Git

### Запуск приложения

1. **Клонирование репозитория**:
```bash
git clone <repository-url>
cd zl0y-billing
```

2. **Запуск всех сервисов**:
```bash
docker-compose up --build
```

Это запустит:
- PostgreSQL на порту 5432
- MongoDB на порту 27017
- Сервис Billing на порту 8080

3. **Ожидание готовности сервисов** (проверьте логи на "Server starting on port 8080")

## Документация API

### Эндпоинты аутентификации

#### Регистрация пользователя
```bash
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "login": "testuser",
    "password": "password123"
  }'
```

#### Вход пользователя
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "login": "testuser",
    "password": "password123"
  }'
```

### Защищенные эндпоинты (требуют заголовок Authorization)

#### Привязка анонимных отчетов
```bash
curl -X POST http://localhost:8080/api/user/link-anonymous \
  -H "Authorization: Bearer ВАШ_JWT_ТОКЕН" \
  -H "Content-Type: application/json" \
  -d '{
    "client_generated_id": "anonymous-session-123"
  }'
```

#### Получение отчетов пользователя
```bash
curl -X GET "http://localhost:8080/api/user/reports?limit=10&offset=0" \
  -H "Authorization: Bearer ВАШ_JWT_ТОКЕН"
```

#### Покупка отчета
```bash
curl -X POST http://localhost:8080/api/reports/ID_ОТЧЕТА/purchase \
  -H "Authorization: Bearer ВАШ_JWT_ТОКЕН"
```

### Mock эндпоинты

#### Создание тестового отчета
```bash
curl -X POST http://localhost:8080/api/mock/create-report \
  -H "Content-Type: application/json" \
  -d '{
    "client_generated_id": "anonymous-session-123"
  }'
```

## Полный пример пользовательского сценария

Вот полный рабочий процесс, демонстрирующий всю функциональность:

```bash
# 1. Регистрация нового пользователя
REGISTER_RESPONSE=$(curl -s -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"login": "johndoe", "password": "securepass123"}')

# Извлечение JWT токена
TOKEN=$(echo $REGISTER_RESPONSE | jq -r '.access_token')
echo "JWT Токен: $TOKEN"

# 2. Создание анонимных отчетов (имитация внешнего сервиса)
curl -X POST http://localhost:8080/api/mock/create-report \
  -H "Content-Type: application/json" \
  -d '{"client_generated_id": "session-abc-123"}'

curl -X POST http://localhost:8080/api/mock/create-report \
  -H "Content-Type: application/json" \
  -d '{"client_generated_id": "session-abc-123"}'

# 3. Привязка анонимных отчетов к зарегистрированному пользователю
curl -X POST http://localhost:8080/api/user/link-anonymous \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"client_generated_id": "session-abc-123"}'

# 4. Получение отчетов пользователя
REPORTS_RESPONSE=$(curl -s -X GET "http://localhost:8080/api/user/reports?limit=5&offset=0" \
  -H "Authorization: Bearer $TOKEN")
echo "Отчеты пользователя: $REPORTS_RESPONSE"

# 5. Извлечение ID первого отчета и его покупка
REPORT_ID=$(echo $REPORTS_RESPONSE | jq -r '.reports[0].report_id')
curl -X POST "http://localhost:8080/api/reports/$REPORT_ID/purchase" \
  -H "Authorization: Bearer $TOKEN"

# 6. Повторная проверка отчетов для просмотра статуса покупки
curl -X GET "http://localhost:8080/api/user/reports?limit=5&offset=0" \
  -H "Authorization: Bearer $TOKEN"
```

## Конфигурация

Переменные окружения можно задать в файле `.env` или через переменные окружения Docker:

- `PORT`: Порт сервера (по умолчанию: 8080)
- `POSTGRES_DSN`: Строка подключения к PostgreSQL
- `MONGO_URI`: URI подключения к MongoDB
- `MONGO_DATABASE`: Имя базы данных MongoDB
- `JWT_SECRET`: Секретный ключ для подписи JWT токенов

## Разработка

### Настройка локальной разработки

1. **Установка зависимостей**:
```bash
go mod download
```

2. **Запуск баз данных локально**:
```bash
docker-compose up postgres mongodb -d
```

3. **Запуск приложения**:
```bash
go run main.go
```

### Тестирование

Сервис включает комплексную обработку ошибок и валидацию:
- Аутентификация и авторизация пользователей
- Подключение к базам данных и транзакции
- Валидация и санитизация запросов
- Согласованность между базами данных для покупок

## Рекомендации для продакшена

Для развертывания в продакшене рассмотрите:

1. **Безопасность**:
    - Смените JWT секрет на сильное, случайное значение
    - Используйте учетные данные баз данных для конкретной среды
    - Включите TLS/SSL для подключений к базам данных
    - Реализуйте ограничение скорости запросов

2. **Масштабируемость**:
    - Добавьте пул соединений с базой данных
    - Реализуйте слой кеширования (Redis)
    - Добавьте возможности горизонтального масштабирования
    - Мониторинг производительности базы данных

3. **Надежность**:
    - Реализуйте правильную обработку распределенных транзакций
    - Добавьте автоматические выключатели для внешних сервисов
    - Настройте мониторинг и оповещения
    - Реализуйте graceful shutdown

4. **Согласованность данных**:
    - Рассмотрите использование паттерна saga для транзакций между базами данных
    - Реализуйте идемпотентность для операций покупки
    - Добавьте аудит-логирование для финансовых операций

## Использование Makefile

Проект включает Makefile для удобства разработки:

```bash
make help          # Показать доступные команды
make docker-up     # Запустить все сервисы
make docker-down   # Остановить все сервисы
make logs          # Просмотр логов приложения
make dev-setup     # Настройка среды разработки
make restart       # Полный перезапуск сервисов
```

## Бизнес-логика

### Система биллинга
- Каждый пользователь начинает с баланса 100.00 руб (10000 центов)
- Стоимость отчета: 5.00 руб (500 центов)
- При покупке баланс уменьшается, статус отчета меняется на `is_purchased: true`

### Привязка анонимных отчетов
- Анонимные отчеты создаются с `client_generated_id` без `user_id`
- После регистрации пользователь может привязать все анонимные отчеты по `client_generated_id`
- Привязанные отчеты получают `user_id` и становятся доступными для покупки

### Транзакционная согласованность
Хотя используются две разные базы данных, система имитирует транзакционную согласованность:
1. Проверка баланса пользователя в PostgreSQL
2. Списание средств с баланса
3. Обновление статуса отчета в MongoDB

В случае ошибки на любом этапе операция прерывается.

## Мониторинг и логирование

Приложение готово для интеграции с системами мониторинга:
- Структурированное логирование всех операций
- Health check endpoints готовы к реализации
- Метрики производительности могут быть легко добавлены
- Трассировка запросов поддерживается

## Лицензия

Данный проект является частью технического задания для zl0y.team.